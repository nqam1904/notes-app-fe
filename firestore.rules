rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate folder data
    function isValidFolder() {
      return request.resource.data.keys().hasAll(['name', 'userId', 'createdAt', 'updatedAt'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.userId is string;
    }
    
    // Helper function to validate note data
    function isValidNote() {
      return request.resource.data.keys().hasAll(['title', 'content', 'status', 'isPinned', 'isLocked', 'userId', 'createdAt', 'updatedAt'])
        && request.resource.data.title is string
        && request.resource.data.content is string
        && request.resource.data.status in ['active', 'archived', 'trashed']
        && request.resource.data.isPinned is bool
        && request.resource.data.isLocked is bool
        && request.resource.data.userId is string;
    }
    
    // ========================================
    // FOLDERS COLLECTION
    // ========================================
    match /folders/{folderId} {
      // Users can only read their own folders
      allow read: if isOwner(resource.data.userId);
      
      // Users can only create folders with their own userId and valid data
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && isValidFolder();
      
      // Users can only update their own folders
      // Cannot change userId or createdAt
      allow update: if isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      // Users can only delete their own folders
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ========================================
    // NOTES COLLECTION
    // ========================================
    match /notes/{noteId} {
      // Users can read:
      // - Their own notes
      // - Notes shared with them (if sharedWith array includes their uid)
      allow read: if isOwner(resource.data.userId)
                  || (isAuthenticated() 
                      && request.auth.uid in resource.data.get('sharedWith', []));
      
      // Users can only create notes with their own userId and valid data
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && isValidNote();
      
      // Users can update:
      // - Their own notes (full update)
      // - Cannot change userId or createdAt
      allow update: if isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      // Users can only delete their own notes
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ========================================
    // USERS COLLECTION (Optional)
    // ========================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can create their own profile
      allow create: if isOwner(userId)
                    && request.resource.data.email is string
                    && request.resource.data.createdAt is timestamp;
      
      // Users can update their own profile
      // Cannot change email or createdAt
      allow update: if isOwner(userId)
                    && request.resource.data.email == resource.data.email
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // ========================================
    // SHARED FOLDERS (Future feature)
    // ========================================
    match /shared_folders/{sharedFolderId} {
      allow read: if isAuthenticated()
                  && request.auth.uid in resource.data.sharedWith;
      
      allow create: if isAuthenticated()
                    && request.resource.data.ownerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated()
                            && request.auth.uid == resource.data.ownerId;
    }
    
    // Deny all other requests
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

